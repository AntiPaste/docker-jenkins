general:
  branches:
    only:
      - master
      - develop

machine:
  environment:
    DOCKER_IMAGE: jenkins
  services:
    - docker

dependencies:
  pre:
    - if [[ ! -e bats ]]; then git clone https://github.com/sstephenson/bats.git && cd bats && sudo ./install.sh /usr/local; fi
  cache_directories:
    - "~/docker"
  override:
    - docker info
    - if [ -e ~/docker/image.tar ]; then docker load --input ~/docker/image.tar; fi
    - echo ${DOCKER_IMAGE} && pwd && ls -lFh
    - docker build -t ${DOCKER_IMAGE}:${VERSION} .
    - mkdir -p ~/docker; docker save ${DOCKER_IMAGE}:${VERSION} > ~/docker/image.tar

test:
  pre:
  override:
    - versions=( 1.* ) && versions=( "${versions[@]%/}" ) && versions=( $(printf '%s\n' "${versions[@]}"|sort -V) ) && for VERSION in "${versions[@]}"; do bats tests ; done

#deployment:
#  hub:
#    branch: master
#    commands:
#      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PWD
#      - docker push $CIRCLE_PROJECT_USERNAME/$DOCKER_IMAGE:$VERSION
